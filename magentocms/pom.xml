<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <artifactId>connectors-se</artifactId>
        <groupId>org.talend.components</groupId>
        <version>1.0.0-SNAPSHOT</version>
    </parent>
    <modelVersion>4.0.0</modelVersion>

    <artifactId>magentocms</artifactId>
    <name>Components :: Magento CMS</name>

    <dependencies>
        <dependency>
            <groupId>oauth.signpost</groupId>
            <artifactId>signpost-core</artifactId>
            <version>1.2.1.2</version>
        </dependency>
        <dependency>
            <groupId>oauth.signpost</groupId>
            <artifactId>signpost-commonshttp4</artifactId>
            <version>1.2.1.2</version>
            <exclusions>
                <exclusion>
                    <groupId>org.apache.httpcomponents</groupId>
                    <artifactId>httpcore</artifactId>
                </exclusion>
            </exclusions>
        </dependency>

        <dependency>
            <groupId>org.apache.httpcomponents</groupId>
            <artifactId>httpclient</artifactId>
            <version>4.5.6</version>
        </dependency>
    </dependencies>

    <!---->
    <build>
        <!--get free port for magento container-->
        <plugins>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-failsafe-plugin</artifactId>
                <configuration>
                    <systemPropertyVariables>
                        <magentoHttpPort>${magento.http.port}</magentoHttpPort>
                        <magentoAdminName>admin</magentoAdminName>
                        <magentoAdminPassword>magentorocks1</magentoAdminPassword>
                    </systemPropertyVariables>
                </configuration>
            </plugin>

            <!--get free port for magento's docker container-->
            <plugin>
                <groupId>org.codehaus.mojo</groupId>
                <artifactId>build-helper-maven-plugin</artifactId>
                <version>3.0.0</version>
                <executions>
                    <execution>
                        <id>reserve-network-port</id>
                        <phase>process-resources</phase>
                        <goals>
                            <goal>reserve-network-port</goal>
                        </goals>
                        <configuration>
                            <portNames>
                                <portName>magento.http.port</portName>
                            </portNames>
                        </configuration>
                    </execution>
                </executions>
            </plugin>

            <!--start/stop magento's docker containers for tests-->
            <plugin>
                <groupId>io.fabric8</groupId>
                <artifactId>docker-maven-plugin</artifactId>
                <configuration>
                    <skip>${maven.test.skip}</skip>
                    <images>
                        <image>
                            <alias>db</alias>
                            <name>mysql:5.6.23</name>
                            <run>
                                <envPropertyFile>./docker/magento_env</envPropertyFile>
                                <wait>
                                    <time>3000</time>
                                </wait>
                            </run>
                        </image>

                        <image>
                            <alias>web</alias>
                            <name>alexcheng/magento2</name>
                            <run>
                                <env>
                                    <MAGENTO_URL>http://${docker.host.address}:${magento.http.port}</MAGENTO_URL>
                                </env>
                                <envPropertyFile>./docker/magento_env</envPropertyFile>
                                <ports>
                                    <port>magento.http.port:80</port>
                                </ports>
                                <wait>
                                    <http>
                                        <url>http://${docker.host.address}:${magento.http.port}</url>
                                    </http>
                                    <time>
                                        30000
                                    </time>
                                </wait>
                                <links>
                                    <link>db:db</link>
                                </links>
                            </run>
                        </image>
                    </images>
                </configuration>

                <executions>
                    <execution>
                        <id>start</id>
                        <phase>pre-integration-test</phase>
                        <goals>
                            <goal>start</goal>
                        </goals>
                    </execution>
                    <execution>
                        <id>stop</id>
                        <phase>post-integration-test</phase>
                        <goals>
                            <goal>stop</goal>
                        </goals>
                    </execution>
                </executions>
            </plugin>

            <plugin>
                <groupId>org.codehaus.mojo</groupId>
                <artifactId>exec-maven-plugin</artifactId>
                <version>1.6.0</version>
                <executions>
                    <execution>
                        <id>docker-install-magento</id>
                        <phase>pre-integration-test</phase>
                        <goals>
                            <goal>exec</goal>
                        </goals>
                        <configuration>
                            <skip>${maven.test.skip}</skip>
                            <executable>docker</executable>
                            <arguments>
                                <argument>exec</argument>
                                <argument>${docker.container.web.id}</argument>
                                <argument>install-magento</argument>
                            </arguments>
                        </configuration>
                    </execution>

                    <execution>
                        <id>docker-install-sampledata</id>
                        <phase>pre-integration-test</phase>
                        <goals>
                            <goal>exec</goal>
                        </goals>
                        <configuration>
                            <skip>${maven.test.skip}</skip>
                            <executable>docker</executable>
                            <arguments>
                                <argument>exec</argument>
                                <argument>${docker.container.web.id}</argument>
                                <argument>install-sampledata</argument>
                            </arguments>
                        </configuration>
                    </execution>

                    <execution>
                        <id>docker-copy-script-install-integration</id>
                        <phase>pre-integration-test</phase>
                        <goals>
                            <goal>exec</goal>
                        </goals>
                        <configuration>
                            <skip>${maven.test.skip}</skip>
                            <executable>docker</executable>
                            <arguments>
                                <argument>cp</argument>
                                <argument>
                                    ./docker/add_integr
                                </argument>
                                <argument>${docker.container.web.id}:/var/www/html/add_integr</argument>
                            </arguments>
                        </configuration>
                    </execution>

                    <execution>
                        <id>docker-install-integration</id>
                        <phase>pre-integration-test</phase>
                        <goals>
                            <goal>exec</goal>
                        </goals>
                        <configuration>
                            <skip>${maven.test.skip}</skip>
                            <executable>docker</executable>
                            <arguments>
                                <argument>exec</argument>
                                <argument>${docker.container.web.id}</argument>
                                <argument>./add_integr</argument>
                            </arguments>
                        </configuration>
                    </execution>
                </executions>
            </plugin>
        </plugins>
    </build>
    <!---->

</project>